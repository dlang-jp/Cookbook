
<!DOCTYPE html>
<html>    <head>        <meta name="viewport" content="width=device-width,initial-scale=1">
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <link rel="stylesheet" type="text/css" href="css/proj_docs.css">
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script type="text/javascript" src="js/sidebar.js"></script>
        <script type="text/javascript" src="js/listanchors.js"></script>
        <title>data.csv_example</title>
        
        
    </head>
    <body>        
        <div class="container">            
<div class="sidebar-underbar"></div>
<div class="sidebar">    <div class="head">        <h2>cookbook</h2>
        <p><span class="smallprint"><b>version:</b> ~master <span class="separator"><br></span>
            </span>
        </p>
        <p><a href="index.html">overview</a></p>
    </div>
    
    <ul>

	

	<li><a href="cookbook--array_example.html"><span >配列</span></a></li>



	<li><a href="cookbook--assoc_array_example.html"><span >連想配列</span></a></li>



	<li><a href="cookbook--concurrency_example.html"><span >並行処理</span></a></li>


	
		<li class="expand-container open"><a class='expand-toggle' href="#"><span >データ形式
		</span></a><ul><li><a href="
			cookbook--data.html"><span >overview</span></a></li>
			

	<li><a href="cookbook--data.csv_example.html"><span >CSV操作</span></a></li>



	<li><a href="cookbook--data.json_example.html"><span >JSON操作</span></a></li>

</ul></li>
	
	





	<li><a href="cookbook--datetime_example.html"><span >時刻・日付</span></a></li>



	<li><a href="cookbook--file_example.html"><span >ファイルシステム</span></a></li>



	<li><a href="cookbook--getopt_example.html"><span >コマンドライン解析</span></a></li>



	<li><a href="cookbook--is_example.html"><span >is式</span></a></li>



	<li><a href="cookbook--meta_example.html"><span >メタプログラミング</span></a></li>



	<li><a href="cookbook--network_example.html"><span >ネットワーク(cURL)</span></a></li>



	<li><a href="cookbook--process_example.html"><span >プロセス</span></a></li>



	<li><a href="cookbook--random_example.html"><span >乱数</span></a></li>



	<li><a href="cookbook--range_example.html"><span >レンジ</span></a></li>



	<li><a href="cookbook--regex_example.html"><span >正規表現</span></a></li>



	<li><a href="cookbook--string_example.html"><span >文字列</span></a></li>



	<li><a href="cookbook--uda_example.html"><span >UDA(User Defined Attribute)</span></a></li>



	<li><a href="cookbook--unittests_example.html"><span >単体テスト</span></a></li>





	
	
	
		<li class="expand-container open"><a class='expand-toggle' href="#"><span >subpkg</span></a><ul>
			

	<li><a href="cookbook-subpkg--subpkg.test.html"><span >サブパッケージの作り方</span></a></li>


		</ul></li>
	







	
	
	
		<li class="expand-container open"><a class='expand-toggle' href="#"><span >windows</span></a><ul>
			

	<li><a href="cookbook-windows--windows.basic.html"><span >Win32API</span></a></li>


		</ul></li>
	







	
	
	
		<li class="expand-container open"><a class='expand-toggle' href="#"><span >libdparse_usage</span></a><ul>
			

	<li><a href="cookbook-libdparse_usage--libdparse_usage.example.html"><span >libdparse</span></a></li>


		</ul></li>
	




</ul>
</div>
            <div class="content">                
                <div class="quickindex" id="quickindex"></div>
                
                <h1><div class="ddoc_summary">CSV操作
</div></h1><div class="ddoc_description">CSVファイル/CSVデータの読み書き等操作を扱います。
ここでは、標準で備えているstd.csvモジュールを用いたCSVファイルの読み込みと、
CSVファイルへの書き出しについて説明します。</div>
<div class="ddoc_examples"><span class="ddoc_examples_header">Examples:</span>
 <h1>CSVのパース</h1>
<pre class="d_code notranslate"><span class="d_keyword">import</span> std.csv;
<span class="d_keyword">import</span> std.algorithm, std.array, std.string;
<span class="d_comment">// サンプルのCSV
</span><span class="d_keyword">enum</span> string csv1 = <span class="d_string">`
    a,b,c,d,e
    1,2,3,4,5
    6,7,8,9,10
`</span>.outdent.strip;

<span class="d_comment">// 文字列からをCSVとしてパースして、文字列の2次元配列にします
</span><span class="d_comment">// 以下はワンライナーで取れるようにしていますが、
</span><span class="d_comment">// csvReader(csv1)した各レコード(1行ごとに各列(Range)が格納されたRange)を、
</span><span class="d_comment">// mapとarrayで配列に変換しているだけです。
</span><span class="d_keyword">auto</span> mat = csvReader(csv1).map!array.array;
<span class="d_keyword">assert</span>(mat[0][0] == <span class="d_string">"a"</span>);
<span class="d_keyword">assert</span>(mat[0][1] == <span class="d_string">"b"</span>);
<span class="d_keyword">assert</span>(mat[1][0] == <span class="d_string">"1"</span>);
</pre>
</div>
<div class="ddoc_examples"><span class="ddoc_examples_header">Examples:</span>
 もう少し複雑な場合
<pre class="d_code notranslate"><span class="d_keyword">import</span> std.csv;
<span class="d_keyword">import</span> std.algorithm, std.array, std.string, std.exception;
<span class="d_comment">// サンプルのCSV
</span><span class="d_comment">// 今回はヘッダ付きです。
</span><span class="d_keyword">enum</span> string csv1 = <span class="d_string">`
    Name,Height,BloodType
    Cocoa,154,B
    Chino,144,AB
    Rize,160,A
`</span>.outdent.strip;

<span class="d_comment">// 配列に直すのはこうしておくと楽
</span><span class="d_keyword">alias</span> toMat = r =&gt; r.map!array.array;

<span class="d_comment">// 文字列からをCSVとしてパースして、文字列の2次元配列にします
</span><span class="d_comment">// 何もしないとヘッダも読み込まれてしまいます
</span><span class="d_keyword">auto</span> mat = toMat(csv1.csvReader);
<span class="d_keyword">assert</span>(mat[0][0] == <span class="d_string">"Name"</span>);
<span class="d_keyword">assert</span>(mat[0][1] == <span class="d_string">"Height"</span>);
<span class="d_keyword">assert</span>(mat[1][0] == <span class="d_string">"Cocoa"</span>);
<span class="d_keyword">assert</span>(mat[1][2] == <span class="d_string">"B"</span>);


<span class="d_comment">// 今回のCSVにはヘッダが付与されていますが、
</span><span class="d_comment">// csvReaderの2つ目の引数にnullを指定するとその分を無視することができます
</span><span class="d_comment">// あるいは、取得するデータをピックアップすることもできます。
</span><span class="d_comment">// ※右列のデータを左列に持ってくるような並べ替えはできません
</span><span class="d_keyword">auto</span> mat2 = toMat(csv1.csvReader(<span class="d_keyword">null</span>));
<span class="d_keyword">assert</span>(mat2[0][0] == <span class="d_string">"Cocoa"</span>);
<span class="d_keyword">assert</span>(mat2[0][1] == <span class="d_string">"154"</span>);
<span class="d_keyword">assert</span>(mat2[1][0] == <span class="d_string">"Chino"</span>);
<span class="d_keyword">assert</span>(mat2[1][2] == <span class="d_string">"AB"</span>);
<span class="d_keyword">auto</span> mat3 = toMat(csv1.csvReader([<span class="d_string">"Name"</span>, <span class="d_string">"BloodType"</span>]));
<span class="d_keyword">assert</span>(mat3[0][0] == <span class="d_string">"Cocoa"</span>);
<span class="d_keyword">assert</span>(mat3[0][1] == <span class="d_string">"B"</span>);
<span class="d_keyword">assert</span>(mat3[1][0] == <span class="d_string">"Chino"</span>);
<span class="d_keyword">assert</span>(mat3[1][1] == <span class="d_string">"AB"</span>);
<span class="d_comment">// こんな感じの並べ替えはHeaderMismatchExceptionでNG
</span>assertThrown!HeaderMismatchException(
    toMat(csv1.csvReader([<span class="d_string">"Name"</span>, <span class="d_string">"BloodType"</span>, <span class="d_string">"Height"</span>])));
</pre>
</div>
<div class="ddoc_examples"><span class="ddoc_examples_header">Examples:</span>
 構造体でデータ構造をレイアウトする場合
<pre class="d_code notranslate"><span class="d_keyword">import</span> std.csv;
<span class="d_keyword">import</span> std.array, std.string;
<span class="d_comment">// サンプルのCSV
</span><span class="d_comment">// さっきと同じ
</span><span class="d_keyword">enum</span> string csv1 = <span class="d_string">`
    Name,Height,BloodType
    Cocoa,154,B
    Chino,144,AB
    Rize,160,A
`</span>.outdent.strip;

<span class="d_comment">// 次は各行のレコードをこの構造体のデータとして一括読み込みします
</span><span class="d_keyword">struct</span> CharactorData
{
    <span class="d_keyword">enum</span> BloodType { A, B, AB, O }
    string    name;
    BloodType bloodType;
    <span class="d_keyword">int</span>       height;
}
<span class="d_comment">// csvReaderの1つ目のテンプレート引数に構造体を渡すと、
</span><span class="d_comment">// そのメンバー変数のレイアウトでCSVを解釈します。
</span><span class="d_comment">// 構造体のメンバー変数はそれぞれstd.conv.toによって文字列と相互に変換可能
</span><span class="d_comment">// でなければなりません。
</span><span class="d_comment">// また、CSVの先頭行にヘッダ情報があるので、構造体の場合並び替えが可能です。
</span><span class="d_comment">// csvRaderの2つ目の引数に文字列の配列を渡してやることで、CSVの1行目を
</span><span class="d_comment">// ヘッダとして解釈し、並び替えを行って読み込むことができます。
</span><span class="d_keyword">auto</span> order = [<span class="d_string">"Name"</span>, <span class="d_string">"BloodType"</span>, <span class="d_string">"Height"</span>];
<span class="d_keyword">auto</span> charactors = csv1.csvReader!CharactorData(order).array;
<span class="d_keyword">assert</span>(charactors[0].name == <span class="d_string">"Cocoa"</span>);
<span class="d_keyword">assert</span>(charactors[1].height == 144);
<span class="d_keyword">assert</span>(charactors[2].bloodType == CharactorData.BloodType.A);
</pre>
</div>
<div class="ddoc_examples"><span class="ddoc_examples_header">Examples:</span>
 <h1>CSVの書き出し</h1>

残念ながら、CSVを書き出す機能はありません。自分で作ります。
以下の例では汎用性を高めるため、<span class="d_inlinecode donthyphenate notranslate">",\n</span>を含むものを変換することを前提とします。
これらが含まれると、各セルをエスケープする必要が出るためです。
数値だけということがあらかじめわかっているときなど、
エスケープする必要がない場合は<span class="d_inlinecode donthyphenate notranslate">format!"%-(%-(%-s,%)\n%)"(mat)</span>とするだけでOK。
<pre class="d_code notranslate"><span class="d_comment">// CSVは、カンマ区切りで列を、改行で行を表すテキストですが、
</span><span class="d_comment">// 細かく言うと、`"`で囲まれた範囲を文字列として処理します。
</span><span class="d_comment">// 文字列の中では、改行やカンマが使用できます。ダブルクォーテーションを
</span><span class="d_comment">// 文字列内で表現する場合は、2つ連続させます。`""`こんな感じに。
</span><span class="d_comment">// つまり、`",\r\n`(ダブルクォーテーションとカンマと改行)が含まれるセルは
</span><span class="d_comment">// `"`で囲んで出力し、さらにその中の`"`は`""`に置換してやります。
</span>string escapeCSV(string txt)
{
    <span class="d_keyword">import</span> std.string, std.array;
    <span class="d_keyword">if</span> (txt.indexOfAny(<span class="d_string">",\"\r\n"</span>) != -1)
        <span class="d_keyword">return</span> <span class="d_string">`"`</span> ~ txt.replace(<span class="d_string">"\""</span>, <span class="d_string">"\"\""</span>) ~ <span class="d_string">`"`</span>;
    <span class="d_keyword">return</span> txt;
}

<span class="d_comment">// 文字列の2次元配列(行列)の各セルをエスケープし、
</span><span class="d_comment">// 各列をカンマ区切り・各行を改行区切りの文字列にします。
</span><span class="d_comment">// ここで、formatが利用できます。`%(%)`という書式で、
</span><span class="d_comment">// Rangeをうまいこと展開できます。
</span>string toCSV(string[][] mat)
{
    <span class="d_keyword">import</span> std.algorithm, std.format;
    <span class="d_keyword">return</span> format!<span class="d_string">"%-(%-(%-s,%)\n%)"</span>(
        mat.map!(row =&gt; row.map!escapeCSV));
}

<span class="d_comment">// 準備
</span><span class="d_keyword">import</span> std.algorithm, std.array, std.csv, std.string;
<span class="d_keyword">alias</span> toMat = r =&gt; r.map!array.array;

<span class="d_comment">// 文字列の行列を…
</span>string[][] mat = [
    [<span class="d_string">"aaa"</span>, <span class="d_string">"bb,b"</span>, <span class="d_string">"c\nc"</span>],
    [<span class="d_string">"123"</span>, <span class="d_string">"x\"y"</span>, <span class="d_string">"\"xxx\""</span>]];
<span class="d_comment">// CSVに変換！
</span><span class="d_keyword">auto</span> csv = toCSV(mat);
<span class="d_comment">// 中身はこう
</span><span class="d_keyword">assert</span>(csv == <span class="d_string">`
    aaa,"bb,b","c
    c"
    123,"x""y","""xxx"""
`</span>.outdent.strip);

<span class="d_comment">// もう一度文字列の行列に戻して比較しても一致！
</span><span class="d_keyword">assert</span>(equal(toMat(csv.csvReader), mat));
</pre>
</div>

                
            </div>
        </div>
        
        <script type="text/javascript">jQuery(document).ready(listanchors);</script>
        
        
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
     </body>
</html>