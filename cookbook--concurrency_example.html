
<!DOCTYPE html>
<html>    <head>        <META http-equiv="content-type" content="text/html; charset=utf-8">
        <link rel="stylesheet" type="text/css" href="css/proj_docs.css">
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script type="text/javascript" src="js/sidebar.js"></script>
        <script type="text/javascript" src="js/listanchors.js"></script>
        <title>concurrency_example</title>
        
        
    </head>
    <body>        
        <div class="container">            
<div class="sidebar-underbar"></div>
<div class="sidebar">    <div class="head">        <h2>cookbook</h2>
        <p><span class="smallprint"><b>version:</b> ~master <span class="separator"><br></span>
            </span>
        </p>
        <p><a href="index.html">overview</a></p>
    </div>
    
    <ul>

	

	<li><a href="cookbook--array_example.html"><span >array_example</span></a></li>



	<li><a href="cookbook--assoc_array_example.html"><span >assoc_array_example</span></a></li>



	<li><a href="cookbook--concurrency_example.html"><span >concurrency_example</span></a></li>



	<li><a href="cookbook--datetime_example.html"><span >datetime_example</span></a></li>



	<li><a href="cookbook--file_example.html"><span >file_example</span></a></li>



	<li><a href="cookbook--getopt_example.html"><span >getopt_example</span></a></li>



	<li><a href="cookbook--is_example.html"><span >is_example</span></a></li>



	<li><a href="cookbook--network_example.html"><span >network_example</span></a></li>



	<li><a href="cookbook--process_example.html"><span >process_example</span></a></li>



	<li><a href="cookbook--random_example.html"><span >random_example</span></a></li>



	<li><a href="cookbook--range_example.html"><span >range_example</span></a></li>



	<li><a href="cookbook--regex_example.html"><span >regex_example</span></a></li>



	<li><a href="cookbook--string_example.html"><span >string_example</span></a></li>



	<li><a href="cookbook--uda_example.html"><span >uda_example</span></a></li>





	
	<li class="expand-container open"><a class='expand-toggle' href="#"><span >subpkg</span></a><ul>
		
		

	<li><a href="cookbook-subpkg--subpkg.test.html"><span >test</span></a></li>


	</ul></li>






	
	<li class="expand-container open"><a class='expand-toggle' href="#"><span >windows</span></a><ul>
		
		

	<li><a href="cookbook-windows--windows.basic.html"><span >basic</span></a></li>


	</ul></li>



</ul>
</div>
            <div class="content">                <h1>concurrency_example</h1>
                
                <div class="quickindex" id="quickindex"></div>
                
                <div class="ddoc_summary"><span class="d_inlinecode donthyphenate notranslate">std.concurrency</span> を使った並行処理の例をまとめます。</div><div class="ddoc_examples"><span class="ddoc_examples_header">Examples:</span>
 ファイルの書き込みを専用のスレッドで処理することで、大量の書き込みを効率良く行う例です。
<div class="ddoc_blankline"></div>

これは主に大量の繰り返し計算に伴うログの記録や計算の途中経過を保存する場合のパターンとして役立ちます。
<pre class="d_code notranslate"><span class="d_comment">/+
概要:
    std.concurrency は、spawn,send,receiveという関数を用いてスレッド間でメッセージのやり取りができます。
    それぞれ以下のように使用します。

    1. spawn で処理のためのスレッドを起動し、Tidと呼ばれるスレッドのIDを表す構造体を取得します。
    2. send でTidに対応したスレッドへメッセージを送ります。
    3. receive を使い、起動された処理の中でメッセージの到着を待機します。
+/</span>

<span class="d_keyword">import</span> std.concurrency : ownerTid, spawn, send, receive, receiveOnly;
<span class="d_keyword">import</span> std.file : remove;

<span class="d_keyword">enum</span> logFilePath = <span class="d_string">"./concurrencylog.txt"</span>;

<span class="d_keyword">scope</span> (exit)
    remove(logFilePath);

<span class="d_comment">// 書き込みの処理を行うスレッドを起動します。
</span><span class="d_comment">// 処理の内容は同期的に記述でき、ファイルのopen/closeは最低限で済みます。
</span><span class="d_keyword">auto</span> writerTid = spawn(() {
    <span class="d_comment">// テストのため、ファイルを閉じるスコープは明示的に分けておきます。
</span>    {
        <span class="d_keyword">import</span> std.stdio : File;

        <span class="d_keyword">auto</span> f = File(logFilePath, <span class="d_string">"w"</span>);

        <span class="d_comment">// 処理をループしながら、receive関数を使ってメッセージの到着を待ちます。
</span>        <span class="d_comment">// stringが渡されたら書き込み、boolが渡されたら処理を抜けます。
</span>        <span class="d_comment">// なお、send/receiveで送受信可能な型はスレッド間で安全に共有できる型に限られます。
</span>        <span class="d_comment">// 詳細は以下を参照してください
</span>        <span class="d_comment">// - https://dlang.org/phobos/std_traits.html#hasUnsharedAliasing
</span>        <span class="d_keyword">bool</span> shutdown = <span class="d_keyword">false</span>;
        <span class="d_keyword">while</span> (!shutdown)
        {
            <span class="d_comment">// メッセージの型毎にハンドラーを記述することができます。
</span>            <span class="d_comment">// dfmt off
</span>            receive(
                (string text) {
                    f.writeln(text);
                },
                (<span class="d_keyword">bool</span> _) {
                    shutdown = <span class="d_keyword">true</span>;
                },
            );
            <span class="d_comment">// dfmt on
</span>        }
    }

    <span class="d_comment">// 処理が終わったことを起動元のスレッドに通知します。
</span>    send(ownerTid, <span class="d_keyword">true</span>);
});

<span class="d_comment">// 何か計算をしながら必要なデータを書き込み用スレッドに送ります。
</span><span class="d_keyword">foreach</span> (i; 0 .. 360)
{
    <span class="d_keyword">import</span> std.math : sin, PI;
    <span class="d_keyword">import</span> std.format : format;

    send(writerTid, format!<span class="d_string">"data : %f"</span>(sin(i / 180.0 * PI)));
}

<span class="d_comment">// 書き込みたいデータは送り終わったため、シャットダウン用のメッセージを送ります。
</span>send(writerTid, <span class="d_keyword">true</span>);

<span class="d_comment">// 書き込み用スレッドの処理が完了するまで待ちます。
</span><span class="d_comment">// これはテストなので、ログを削除するためにファイルの書き込みを待機しています。
</span>receiveOnly!<span class="d_keyword">bool</span>();
</pre>
</div>
<div class="ddoc_examples"><span class="ddoc_examples_header">Examples:</span>
 前述の大量書き込みの例に対し、起動する処理を使いまわしが可能な関数として定義する例です。
<div class="ddoc_blankline"></div>

実行に必要なパラメーターを引数として宣言しておくとspawnの際に渡すことができます。
<pre class="d_code notranslate"><span class="d_keyword">import</span> std.concurrency : Tid, thisTid, spawn, send, receive, receiveOnly;
<span class="d_keyword">import</span> std.file : remove;

<span class="d_comment">// 汎用的な書き込みを行う関数を定義します。
</span><span class="d_comment">// ここで付与するstaticは、unittest内の変数をキャプチャしないことを明示しています。
</span><span class="d_keyword">static</span> <span class="d_keyword">void</span> writer(Tid reportTid, string filepath)
{
    <span class="d_comment">// 前述の例とほぼ同じです。
</span>    {
        <span class="d_keyword">import</span> std.stdio : File;

        <span class="d_keyword">auto</span> f = File(filepath, <span class="d_string">"w"</span>);

        <span class="d_keyword">bool</span> shutdown = <span class="d_keyword">false</span>;
        <span class="d_keyword">while</span> (!shutdown)
        {
            <span class="d_comment">// dfmt off
</span>            receive(
                (string text) {
                    f.writeln(text);
                },
                (<span class="d_keyword">bool</span> _) {
                    shutdown = <span class="d_keyword">true</span>;
                }
            );
            <span class="d_comment">// dfmt on
</span>        }
    }

    send(reportTid, <span class="d_keyword">true</span>);
}

<span class="d_keyword">enum</span> logFilePath = <span class="d_string">"concurrencylog.txt"</span>;

<span class="d_comment">// spawnの際に引数を指定することができます。
</span><span class="d_comment">// 今回は、ファイルパスと報告先のスレッドとして単体テストを行う現在のスレッドIDを指定します。
</span><span class="d_keyword">auto</span> writerTid = spawn(&amp;writer, thisTid, logFilePath);
<span class="d_keyword">scope</span> (exit)
    remove(logFilePath);

<span class="d_keyword">foreach</span> (i; 0 .. 360)
{
    <span class="d_keyword">import</span> std.math : sin, PI;
    <span class="d_keyword">import</span> std.format : format;

    send(writerTid, format!<span class="d_string">"data : %f"</span>(sin(i / 180.0 * PI)));
}

<span class="d_comment">// 書き込みたいデータは送り終わったため、シャットダウン用のメッセージを送ります。
</span>send(writerTid, <span class="d_keyword">true</span>);

<span class="d_comment">// 書き込み用スレッドの処理が完了するまで待ちます。
</span><span class="d_comment">// これはテストなので、ログを削除するためにファイルの書き込みを待機しています。
</span>receiveOnly!<span class="d_keyword">bool</span>();
</pre>
</div>

                
            </div>
        </div>
        
        <script type="text/javascript">jQuery(document).ready(listanchors);</script>
        
        
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
     </body>
</html>